# 要件定義書 - 実装詳細

## 実装詳細

### 6.1 認証フロー
- **ユーザー登録**:
  1. 管理者がSupabaseダッシュボードで承認済みメールアドレスを登録
  2. ユーザーがGoogle OAuthでログイン
  3. 初回ログイン時にユーザープロファイル情報を保存
- **ログイン**:
  1. Google OAuthによるログイン
  2. 開発環境では環境変数によりID/パスワードログインも可能
- **ログアウト**:
  1. Supabase認証セッションの破棄
  2. クライアント側のキャッシュクリア

### 6.2 状態管理戦略
- **Context API**:
  - ユーザー認証状態の管理
  - テーマ設定（ダークモード/ライトモード）
  - グローバル設定の管理

### 6.3 キャッシュ戦略
- ローカルストレージを活用したキャッシュ管理
- ノートデータは5分間キャッシュ
- プロジェクト一覧は1時間キャッシュ
- タグデータは10分間キャッシュ
- ユーザー情報は24時間キャッシュ

### 6.4 タグ抽出ロジック
- **抽出方法**:
  1. マークダウンコンテンツから正規表現 `/#([a-zA-Z0-9_\-/\p{L}\p{N}]+)/gu` を使用してタグを抽出
     1. タグに使用できる文字は、半角英数字、全角英数字、アンダースコア、ハイフン、スラッシュ、漢字、ひらがな、カタカナです
  2. 抽出したタグをデータベースに保存（既存タグは更新、新規タグは作成）
  3. ノートとタグの関連付けを更新
  4. タグは半角スペースまたは全角スペース以外の文字で構成される
- **実装場所**:
  1. Next.jsのAPIルートで実装する
  2. フロントエンドからノート保存/更新リクエスト時にタグ抽出処理を実行
  3. データベーストリガーではなくアプリケーションロジックとして実装することで、ビジネスロジックとデータ永続化の責務を分離
- **タグと同名のノート検出**:
  1. タグ名と同じタイトルのノートを検索
  2. 存在する場合は青色、存在しない場合はピンク色でタグを表示
  3. タグクリック時に同名ノートが存在すればそのノートに遷移

### 6.5 ファイルストレージ実装
- **ストレージサービス**: Supabase Storage
- **アクセス制御**:
  1. Row Level Security (RLS) ポリシーによるアクセス制御
  2. プロジェクト所有者のみがファイルの読み取り・書き込み権限を持つ
- **ファイル管理**:
  1. プロジェクトごとに独立したバケットを作成
  2. ファイル名の衝突を避けるためにUUIDベースのファイル名を使用
  3. オリジナルファイル名とメタデータを別途データベースに保存
  4. ファイルサイズ上限：10MB
  5. フェーズ3でプロジェクトごとに1GBの容量制限を実装
  6. ファイル管理画面の実装（一覧表示、削除、メタデータ確認など）
- **メタデータ管理**:
  1. データベースでファイルメタデータを管理（ファイル名、サイズ、タイプ、アップロード日時など）
  2. 専用のFileテーブルでファイル情報を管理（オリジナル名、ストレージパス、MIME型、サイズなど）
  3. ノートとファイルの関連付けをデータベースで管理
  4. フェーズ3でファイル管理画面を実装
- **画像処理**:
  1. 表示時のみ画像をリサイズ（大きい画像は表示領域に収まるようにリサイズ）
  2. アップロード時のリサイズは行わない
  3. 画像の最適化（WebP形式への変換など）
  4. サムネイル生成

### 6.6 エディタ実装
- **使用ライブラリ**: Tiptap
- **主要機能**:
  - マークダウンライクなショートカットキー（`#`, `-`, `*` など）
  - タグの自動補完
  - WYSIWYG編集体験

### 6.7 エラーハンドリング戦略
- **ネットワークエラー**:
  - オフライン時はローカルストレージにデータを一時保存
  - オンライン復帰時に自動同期
  - 競合解決のためのマージ戦略を実装
- **認証エラー**:
  - セッション期限切れ時の自動リフレッシュ
  - リフレッシュ失敗時のログインページへのリダイレクト
- **データ操作エラー**:
  - 楽観的更新の失敗時のロールバック
  - ユーザーへのエラー通知（トースト表示）
  - エラーログの記録と分析

### 6.8 URL設計

- **ルートパス**: `/` (トップページ)
- **ログインページ**: `/login` (ログインページ)
  - 環境変数がTrueだったらID/パスワードでのログイン
  - Google OAuthログイン
- **ノート一覧ページ**: `/projects/:projectId/notes` (ノート一覧ページ)
  - 新規ノート作成ページへ遷移するためのボタン
  - ノート一覧表示
  - ノート編集ページへの遷移
  - 検索機能
    - 検索できる要素
      - ノートタイトル
      - ノートの内容
      - タグ
    - 検索結果の表示は表示されているノート一覧にフィルターがかかるイメージで表示する
  - テンプレート作成
  - テンプレート選択
- **ノート編集ページ**: `/projects/:projectId/notes/:noteId` (ノート編集ページ)
  - タイトル入力
  - ノート編集
  - ノート削除
  - テンプレート呼び出し
  - 同じタグが付いているノートの表示
  - ノート名と完全一致するタグをつけているノートの表示
- **新規ノート作成ページ**: `/projects/:projectId/notes/new` (新規ノート作成ページ)
  - タイトル入力
  - ノート編集
  - ノート作成
  - テンプレート呼び出し
- **プロジェクト一覧ページ**: `/projects` (プロジェクト一覧ページ)
  - プロジェクト一覧表示
  - プロジェクト編集ページへの遷移
  - プロジェクト作成ページへの遷移
  - プロジェクトアーカイブページへの遷移
  - プロジェクト検索
- **プロジェクト設定ページ**: `/projects/:projectId/setting` (プロジェクト設定ページ)
  - プロジェクト名の変更
  - プロジェクトのアーカイブ
  - プロジェクトの削除
- **プロジェクトアーカイブページ**: `/projects/:projectId/archive` (プロジェクトアーカイブページ)
  - プロジェクトアーカイブ
  - プロジェクトの復元
- **プロジェクト作成ページ**: `/projects/new` (プロジェクト作成ページ)
  - プロジェクト名の入力
  - プロジェクト作成
- **ファイル管理ページ**: `/projects/:projectId/files` (ファイル管理ページ)
  - ファイル一覧表示
  - ファイルの削除
  - ノートのエクスポート/インポート機能
- **ユーザー設定**: `/user/settings` (ユーザー設定ページ)
  - ユーザ名変更
  - パスワード変更
- **テンプレート作成ページ**: `/projects/:projectId/templates/new` (テンプレート作成ページ)
  - テンプレート名の入力
  - テンプレート作成
- **テンプレート編集ページ**: `/projects/:projectId/templates/:templateId` (テンプレート編集ページ)
  - テンプレート名の変更
  - テンプレートの削除
