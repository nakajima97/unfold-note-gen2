# 要件定義書
## 1. はじめに
### 1.1 目的
このドキュメントは、このリポジトリで開発を進めているアプリの要件を定義します。  
アプリ名は"Unfold Note"です。  

### 1.2 対象読者
- 開発チーム
- プロジェクト管理者
- テスト担当者
- その他の利害関係者

### 1.3 このシステムが解決したい課題
- 雑にメモを保存しても必要な情報が埋もれることないようにしたい

### 1.4 1.3の解決策
- 書くのが簡単なマークダウン記法を使ってメモを作成できるようにする
- フォルダなどの階層構造を作成しない
- タグを使ってメモ同士のつながりを表現する

### 1.5 ターゲットユーザー

- 開発者本人の個人利用を想定

## 2. 機能要件

### 2.1 ユーザー管理
- **ユーザー登録**: 管理者によって承認されたメールアドレスのみが登録可能
  - allowed_emailsテーブルに承認済みメールアドレスを登録
  - メールアドレスの登録はSupabaseのダッシュボードから直接DBを変更して行う
- **ユーザー認証**: Google OAuthを使用したログイン
  - 例外として環境変数によってID/パスワードでのログインも可能
  - ローカルでの開発をスムーズにすすめるための対処
- **ユーザープロファイル**: 表示名などの基本情報の管理

### 2.2 プロジェクト管理
- **プロジェクト作成**: ユーザーは複数のプロジェクトを作成可能
  - 初回ログイン時にユーザ名のプロジェクトが自動で作成される
- **プロジェクト編集**: プロジェクト名の変更
- **プロジェクトアーカイブ**: 使用しないプロジェクトのアーカイブ
- **プロジェクト削除**: 不要なプロジェクトの削除

### 2.3 ノート管理
- **ノート作成**: マークダウン形式でのノート作成
- **ノート編集**: 既存ノートの編集
- **ノート削除**: 不要なノートの削除
- **ノート一覧表示**: プロジェクト内のノート一覧の表示
- **ノート検索**: タイトルや内容による検索
- **メディアの追加**: ノート内に画像やファイルを追加
  - 画像ファイルのアップロードと表示
  - 画像のリサイズと最適化
  - ファイルのアクセス制御（プロジェクト所有者のみアクセス可能）
  - ドラッグ＆ドロップによるアップロード
  - ファイルサイズ上限：10MB

### 2.4 タグ機能
- **タグ付け**: ノート内に `#タグ名` を記述することでタグ付け
- **タグ抽出**: ノートの作成・更新時に自動的にタグを抽出し、データベースに保存
- **タグ検索**: 特定のタグが付けられたノートの検索
- **タグ提案**: 既存のタグに基づく入力候補の表示
- **タグ関連表示**: ノートに関連するタグの一覧表示
- **タグハイライト**: ノート内のタグを視覚的に強調表示
- **タグ参照検出**: 存在しないタグへの参照の検出と表示
- **タグと同名のノートの検出**: タグと完全一致するノートの検出と表示
  - タグの意味を記述できるようにするのが目的
  - タグ名をクリックすることで該当ノートに遷移する
  - 完全一致するノートが存在するかはタグの色で示す
    - 存在しない場合はピンク
    - 存在する場合は青

### 2.5 UI/UX要件
- **レスポンシブデザイン**: 様々なデバイスでの使用に対応
- **ダークモード**: 明暗切り替え機能
- **キーボードショートカット**: 効率的な操作のためのショートカット

### 2.6 エディタ機能
- **Tiptap**: リッチテキストエディタライブラリを使用
  - マークダウンライクなショートカットをサポート（例: `#` で見出し、`-` で箇条書き）
  - WYSIWYG（What You See Is What You Get）形式でコンテンツを編集
  - 利用者にとってはマークダウンエディタに近い使い勝手を提供

### 2.7 データ管理
- **自動保存**: 編集内容の自動保存
- **エクスポート**: マークダウン、PDF、HTMLなどの形式でのエクスポート
- **インポート**: 外部ファイルからのインポート

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **応答時間**: ページロードは2秒以内、操作応答は0.5秒以内
- **同時接続**: 最大100ユーザーの同時接続をサポート
- **スケーラビリティ**: ユーザー数やデータ量の増加に対応できる設計

### 3.2 セキュリティ要件
- **データ暗号化**: 保存データの暗号化
- **セキュアな通信**: HTTPSによる通信
- **認証**: 安全な認証メカニズム
- **アクセス制御**: 適切な権限管理
- **脆弱性対策**: XSS、CSRF、SQLインジェクションなどへの対策

### 3.3 可用性要件
- **稼働時間**: 99.9%以上の稼働率（計画メンテナンス除く）
- **バックアップ**: 定期的なデータバックアップ
- **障害復旧**: 障害発生時の迅速な復旧手順

### 3.4 互換性要件
- **ブラウザ互換性**: 最新のChrome、Firefox、Safari、Edgeをサポート
- **デバイス互換性**: デスクトップ、タブレット、モバイルデバイスでの動作

## 4. データモデル

### 4.1 ユーザーモデル
```
User {
  id: string (primary key)
  email: string
  displayName: string
  avatarUrl: string (optional)
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.2 プロジェクトモデル
```
Project {
  id: string (primary key)
  name: string
  description: string (optional)
  ownerId: string (foreign key -> User.id)
  isArchived: boolean
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.3 ノートモデル
```
Note {
  id: string (primary key)
  title: string
  content: string (markdown)
  projectId: string (foreign key -> Project.id)
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.4 タグモデル
```
Tag {
  id: string (primary key)
  name: string
  projectId: string (foreign key -> Project.id)
  createdAt: timestamp
}
```

### 4.5 ノートタグ関連モデル
```
NoteTag {
  noteId: string (foreign key -> Note.id)
  tagId: string (foreign key -> Tag.id)
  primary key (noteId, tagId)
}
```

### 4.6 ファイルモデル
```
File {
  id: string (primary key)
  originalName: string
  storagePath: string
  mimeType: string
  size: number
  noteId: string (foreign key -> Note.id)
  projectId: string (foreign key -> Project.id)
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.7 許可メールモデル
```
AllowedEmail {
  id: string (primary key)
  email: string (unique)
  createdAt: timestamp
  createdBy: string (foreign key -> User.id, nullable)
}
```

### 4.8 データベース設計

#### 4.8.1 インデックス
- ユーザーテーブル: email列にユニークインデックス
- プロジェクトテーブル: ownerId列にインデックス
- ノートテーブル: projectId列にインデックス、title列にインデックス
- タグテーブル: name列とprojectId列の複合インデックス
- ファイルテーブル: noteId列とprojectId列にインデックス

#### 4.8.2 RLSポリシー（Row Level Security）
- **ユーザーテーブル**: 自分自身のデータのみ読み取り/更新可能
- **プロジェクトテーブル**: 所有者のみ読み取り/更新/削除可能
- **ノートテーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **タグテーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **ノートタグ関連テーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **ファイルテーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **許可メールテーブル**: 管理者ロールを持つユーザーのみ読み取り/作成/更新/削除可能

## 5. 技術スタック

### 5.1 フロントエンド
- **フレームワーク**: Next.js
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS, Shadcn UI
- **状態管理**: Context API
- **エディタ**: Tiptap
- **テスト**: Vitest, React Testing Library, Storybook, PlayWright

### 5.2 バックエンド
- **BaaS**: Supabase
- **データベース**: Supabase Database
- **認証**: Supabase Authentication

### 5.3 インフラストラクチャ
- **ホスティング**: Vercel
- **データベースホスティング**: Supabase
- **ストレージ**: Supabase Storage
- **CDN**: Vercel Edge Network

## 6. 実装詳細

### 6.1 認証フロー
- **ユーザー登録**:
  1. 管理者がSupabaseダッシュボードで承認済みメールアドレスを登録
  2. ユーザーがGoogle OAuthでログイン
  3. 初回ログイン時にユーザープロファイル情報を保存
- **ログイン**:
  1. Google OAuthによるログイン
  2. 開発環境では環境変数によりID/パスワードログインも可能
- **ログアウト**:
  1. Supabase認証セッションの破棄
  2. クライアント側のキャッシュクリア

### 6.2 状態管理戦略
- **Context API**:
  - ユーザー認証状態の管理
  - テーマ設定（ダークモード/ライトモード）
  - グローバル設定の管理

### 6.3 キャッシュ戦略
- ローカルストレージを活用したキャッシュ管理
- ノートデータは5分間キャッシュ
- プロジェクト一覧は1時間キャッシュ
- タグデータは10分間キャッシュ
- ユーザー情報は24時間キャッシュ

### 6.4 タグ抽出ロジック
- **抽出方法**:
  1. マークダウンコンテンツから正規表現 `/#([a-zA-Z0-9_\-/\p{L}\p{N}]+)/gu` を使用してタグを抽出
     1. タグに使用できる文字は、半角英数字、全角英数字、アンダースコア、ハイフン、スラッシュ、漢字、ひらがな、カタカナです
  2. 抽出したタグをデータベースに保存（既存タグは更新、新規タグは作成）
  3. ノートとタグの関連付けを更新
  4. タグは半角スペースまたは全角スペース以外の文字で構成される
- **実装場所**:
  1. Next.jsのAPIルートで実装する
  2. フロントエンドからノート保存/更新リクエスト時にタグ抽出処理を実行
  3. データベーストリガーではなくアプリケーションロジックとして実装することで、ビジネスロジックとデータ永続化の責務を分離
- **タグと同名のノート検出**:
  1. タグ名と同じタイトルのノートを検索
  2. 存在する場合は青色、存在しない場合はピンク色でタグを表示
  3. タグクリック時に同名ノートが存在すればそのノートに遷移

### 6.5 ファイルストレージ実装
- **ストレージサービス**: Supabase Storage
- **アクセス制御**:
  1. Row Level Security (RLS) ポリシーによるアクセス制御
  2. プロジェクト所有者のみがファイルの読み取り・書き込み権限を持つ
- **ファイル管理**:
  1. プロジェクトごとに独立したバケットを作成
  2. ファイル名の衝突を避けるためにUUIDベースのファイル名を使用
  3. オリジナルファイル名とメタデータを別途データベースに保存
  4. ファイルサイズ上限：10MB
  5. フェーズ3でプロジェクトごとに1GBの容量制限を実装
  6. ファイル管理画面の実装（一覧表示、削除、メタデータ確認など）
- **メタデータ管理**:
  1. データベースでファイルメタデータを管理（ファイル名、サイズ、タイプ、アップロード日時など）
  2. 専用のFileテーブルでファイル情報を管理（オリジナル名、ストレージパス、MIME型、サイズなど）
  3. ノートとファイルの関連付けをデータベースで管理
  4. フェーズ3でファイル管理画面を実装
- **画像処理**:
  1. 表示時のみ画像をリサイズ（大きい画像は表示領域に収まるようにリサイズ）
  2. アップロード時のリサイズは行わない
  3. 画像の最適化（WebP形式への変換など）
  4. サムネイル生成

### 6.6 エディタ実装
- **使用ライブラリ**: Tiptap
- **主要機能**:
  - マークダウンライクなショートカットキー（`#`, `-`, `*` など）
  - タグの自動補完
  - WYSIWYG編集体験

### 6.7 エラーハンドリング戦略
- **ネットワークエラー**:
  - オフライン時はローカルストレージにデータを一時保存
  - オンライン復帰時に自動同期
  - 競合解決のためのマージ戦略を実装
- **認証エラー**:
  - セッション期限切れ時の自動リフレッシュ
  - リフレッシュ失敗時のログインページへのリダイレクト
- **データ操作エラー**:
  - 楽観的更新の失敗時のロールバック
  - ユーザーへのエラー通知（トースト表示）
  - エラーログの記録と分析

### 6.8 URL設計

- **ルートパス**: `/` (トップページ)
- **ログインページ**: `/login` (ログインページ)
  - 環境変数がTrueだったらID/パスワードでのログイン
  - Google OAuthログイン
- **ノート一覧ページ**: `/projects/:projectId/notes` (ノート一覧ページ)
  - 新規ノート作成ページへ遷移するためのボタン
  - ノート一覧表示
  - ノート編集ページへの遷移
  - 検索機能
    - 検索できる要素
      - ノートタイトル
      - ノートの内容
      - タグ
    - 検索結果の表示は表示されているノート一覧にフィルターがかかるイメージで表示する
  - テンプレート作成
  - テンプレート選択
- **ノート編集ページ**: `/projects/:projectId/notes/:noteId` (ノート編集ページ)
  - タイトル入力
  - ノート編集
  - ノート削除
  - テンプレート呼び出し
  - 同じタグが付いているノートの表示
  - ノート名と完全一致するタグをつけているノートの表示
- **新規ノート作成ページ**: `/projects/:projectId/notes/new` (新規ノート作成ページ)
  - タイトル入力
  - ノート編集
  - ノート作成
  - テンプレート呼び出し
- **プロジェクト一覧ページ**: `/projects` (プロジェクト一覧ページ)
  - プロジェクト一覧表示
  - プロジェクト編集ページへの遷移
  - プロジェクト作成ページへの遷移
  - プロジェクトアーカイブページへの遷移
  - プロジェクト検索
- **プロジェクト設定ページ**: `/projects/:projectId/setting` (プロジェクト設定ページ)
  - プロジェクト名の変更
  - プロジェクトのアーカイブ
  - プロジェクトの削除
- **プロジェクトアーカイブページ**: `/projects/:projectId/archive` (プロジェクトアーカイブページ)
  - プロジェクトアーカイブ
  - プロジェクトの復元
- **プロジェクト作成ページ**: `/projects/new` (プロジェクト作成ページ)
  - プロジェクト名の入力
  - プロジェクト作成
- **ファイル管理ページ**: `/projects/:projectId/files` (ファイル管理ページ)
  - ファイル一覧表示
  - ファイルの削除
  - ノートのエクスポート/インポート機能
- **ユーザー設定**: `/user/settings` (ユーザー設定ページ)
  - ユーザ名変更
  - パスワード変更
- **テンプレート作成ページ**: `/projects/:projectId/templates/new` (テンプレート作成ページ)
  - テンプレート名の入力
  - テンプレート作成
- **テンプレート編集ページ**: `/projects/:projectId/templates/:templateId` (テンプレート編集ページ)
  - テンプレート名の変更
  - テンプレートの削除

## 7. コーディングガイドライン

### 7.1 コーディング規約
- TypeScriptの型定義を厳格に行う
- Biomeを使用したコード品質の維持
- コンポーネント設計はPresentational/Containerパターンに従う
- テスト駆動開発（TDD）の採用
  - Presentationalコンポーネントのテスト
    - Storybookのストーリーの作成
  - Containerコンポーネントのテスト
    - vitestによる単体テスト

### 7.2 ディレクトリ構造
```
/
├── frontend/
│   ├── .storybook/            # Storybook 設定
│   ├── public/                # 静的ファイル
│   └── src/                   # Next.js アプリディレクトリ
│       ├── app/               # アプリのエントリポイント (Next.js App Router 使用)
│       │   └── (pages/)       # 各ページのファイル (app router の規約に従う)
│       ├── components/        # 再利用可能な UI コンポーネント (アプリ全体で共有)
│       │   ├── ComponentName/ # 例: Button, Input, Header など
│       │   │   ├── index.tsx
│       │   │   └── ComponentName.stories.tsx
│       │   └── ...
│       ├── features/          # 特定の機能に関するコンポーネント、ロジック、ページ
│       │   ├── featureName/   # 例: auth, productList, checkout など
│       │   │   ├── components/      # 機能固有の Presentational Components
│       │   │   │   ├── ComponentName/
│       │   │   │   │   ├── index.tsx
│       │   │   │   │   └── ComponentName.stories.tsx
│       │   │   │   └── ...
│       │   │   ├── containers/     # 機能固有の Container Components (ロジックと状態管理)
│       │   │   │   ├── ContainerName/
│       │   │   │   │   ├── index.tsx
│       │   │   │   │   └── useContainerHook.ts  # コンテナ用のカスタムフック
│       │   │   │   └── ...
│       │   │   ├── hooks/          # 機能固有のカスタムフック
│       │   │   ├── types/          # 機能固有の型定義
│       │   │   └── utils/          # 機能固有のユーティリティ関数
│       │   └── ...
│       ├── hooks/             # アプリ全体で共有するカスタム React フック
│       ├── lib/               # 共有ユーティリティとライブラリ
│       ├── services/          # API サービスレイヤー (API クライアント、データ変換など)
│       └── utils/             # アプリ全体で共有するユーティリティ関数
└── docs/                 # プロジェクトドキュメント
```

### 7.3 開発フロー
- Gitブランチ戦略: GitHub Flow
- プルリクエスト必須
  - 一人で開発しているためセルフレビュー
- CIパイプラインによる自動テスト
- セマンティックバージョニングの採用

### 7.4 テスト戦略
- ユニットテスト: Vitest
- コンポーネントテスト: React Testing Library、Storybook
- E2Eテスト: PlayWright
- テストカバレッジ目標: 80%以上

## 8. マイルストーンとリリース計画

### 8.1 フェーズ1: MVP（最小実用製品）
- Google OAuth
- 初回ログイン時にユーザ名のプロジェクトが自動作成
- ノート作成・編集機能
  - Tiptapを用いたエディタ
- タグ機能
  - 同じタグが付いたノートの表示
  - タグをクリックすることで、完全一致するノートに遷移する
  - タグの色変更
- PC/モバイル対応
- 画像ファイルの添付機能
  - 画像のアップロードと表示
  - Supabase Storageを使用したファイル保存
  - RLSによるアクセス制御

### 8.2 フェーズ2: 機能拡張
- ノート検索機能
- ノート削除機能
- ノート編集内容の自動保存
- プロジェクト作成・編集・アーカイブ・削除機能
- タグでの自動検索

### 8.3 フェーズ3: 洗練と最適化
- パフォーマンス最適化
- タグの自動補完
- ノート作成時に類似ノートが表示される
- タグのつながりをマップ表示する
- テンプレート機能
- 拡張ファイル添付機能
  - 動画ファイルのアップロードと再生
  - PDFファイルのアップロードとプレビュー
  - ファイル管理機能の強化
  - プロジェクトごとに1GBの容量制限
  - ファイル管理画面の実装（一覧表示、削除、メタデータ確認など）
- ユーザー設定
  - パスワードの変更
- ノートエクスポート

## 9. 用語集
- **ノート**: マークダウン形式で作成されるドキュメント
- **プロジェクト**: ノートを整理するためのコンテナ
- **タグ**: ノートを分類・関連付けるためのキーワード
- **マークダウン**: テキストを構造化するための軽量マークアップ言語

## 10. 付録

### 10.1 参考資料
- Next.js ドキュメント: [Next.js](https://nextjs.org/docs)
- Supabase ドキュメント: [Supabase](https://supabase.com/docs)
- Tiptap ドキュメント: [Tiptap](https://tiptap.dev/docs)

### 10.2 UI/UXデザイン参考
- 基本的なカラーパレット: ダークモード/ライトモード対応
- フォント: システムフォントスタック（読みやすさ重視）
- アイコン: Heroicons または Material Icons
