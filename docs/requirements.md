# 要件定義書
## 1. はじめに
### 1.1 目的
このドキュメントは、このリポジトリで開発を進めているアプリの要件を定義します。  
アプリ名は"Unfold Note"です。  

### 1.2 対象読者
- 開発チーム
- プロジェクト管理者
- テスト担当者
- その他の利害関係者

### 1.3 このシステムが解決したい課題
- 雑にメモを保存しても必要な情報が埋もれることないようにしたい

### 1.4 1.3の解決策
- 書くのが簡単なマークダウン記法を使ってメモを作成できるようにする
- フォルダなどの階層構造を作成しない
- タグを使ってメモ同士のつながりを表現する

## 2. 機能要件

### 2.1 ユーザー管理
- **ユーザー登録**: 管理者によって承認されたメールアドレスのみが登録可能
  - allowed_emailsテーブルに承認済みメールアドレスを登録
  - メールアドレスの登録はSupabaseのダッシュボードから行う
- **ユーザー認証**: Google OAuthを使用したログイン
  - 例外として環境変数によってID/パスワードでのログインも可能
  - ローカルでの開発をスムーズにすすめるための対処
- **ユーザープロファイル**: 表示名などの基本情報の管理

### 2.2 プロジェクト管理
- **プロジェクト作成**: ユーザーは複数のプロジェクトを作成可能
- **プロジェクト編集**: プロジェクト名の変更
- **プロジェクトアーカイブ**: 使用しないプロジェクトのアーカイブ
- **プロジェクト削除**: 不要なプロジェクトの削除

### 2.3 ノート管理
- **ノート作成**: マークダウン形式でのノート作成
- **ノート編集**: 既存ノートの編集
- **ノート削除**: 不要なノートの削除
- **ノート一覧表示**: プロジェクト内のノート一覧の表示
- **ノート検索**: タイトルや内容による検索
- **メディアの追加**: ノート内に画像やファイルを追加

### 2.4 タグ機能
- **タグ付け**: ノート内に `#タグ名` を記述することでタグ付け
- **タグ抽出**: ノートの作成・更新時に自動的にタグを抽出し、データベースに保存
- **タグ検索**: 特定のタグが付けられたノートの検索
- **タグ一覧**: 使用されているタグの一覧表示
- **タグ提案**: 既存のタグに基づく入力候補の表示
- **タグ関連表示**: ノートに関連するタグの一覧表示
- **タグハイライト**: ノート内のタグを視覚的に強調表示
- **タグ参照検出**: 存在しないタグへの参照の検出と表示
- **タグと同名のノートの検出**: タグと同名のノートの検出と表示
  - タグ名をクリックすることで該当ノートに遷移する
  - 同名のノートが存在するかはタグの色で示す
    - 存在しない場合はピンク
    - 存在する場合は青

### 2.5 UI/UX要件
- **レスポンシブデザイン**: 様々なデバイスでの使用に対応
- **ダークモード**: 明暗切り替え機能
- **キーボードショートカット**: 効率的な操作のためのショートカット
- **ドラッグ&ドロップ**: 直感的なノート整理

### 2.6 エディタ機能
- **Tiptap**: リッチテキストエディタライブラリを使用
  - マークダウンライクなショートカットをサポート（例: `#` で見出し、`-` で箇条書き）
  - WYSIWYG（What You See Is What You Get）形式でコンテンツを編集
  - 利用者にとってはマークダウンエディタに近い使い勝手を提供

### 2.7 データ管理
- **自動保存**: 編集内容の自動保存
- **エクスポート**: マークダウン、PDF、HTMLなどの形式でのエクスポート
- **インポート**: 外部ファイルからのインポート

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **応答時間**: ページロードは2秒以内、操作応答は0.5秒以内
- **同時接続**: 最大100ユーザーの同時接続をサポート
- **スケーラビリティ**: ユーザー数やデータ量の増加に対応できる設計

### 3.2 セキュリティ要件
- **データ暗号化**: 保存データの暗号化
- **セキュアな通信**: HTTPSによる通信
- **認証**: 安全な認証メカニズム
- **アクセス制御**: 適切な権限管理
- **脆弱性対策**: XSS、CSRF、SQLインジェクションなどへの対策

### 3.3 可用性要件
- **稼働時間**: 99.9%以上の稼働率（計画メンテナンス除く）
- **バックアップ**: 定期的なデータバックアップ
- **障害復旧**: 障害発生時の迅速な復旧手順

### 3.4 互換性要件
- **ブラウザ互換性**: 最新のChrome、Firefox、Safari、Edgeをサポート
- **デバイス互換性**: デスクトップ、タブレット、モバイルデバイスでの動作

## 4. データモデル

### 4.1 ユーザーモデル
```
User {
  id: string (primary key)
  email: string
  displayName: string
  avatarUrl: string (optional)
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.2 プロジェクトモデル
```
Project {
  id: string (primary key)
  name: string
  description: string (optional)
  ownerId: string (foreign key -> User.id)
  isArchived: boolean
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.3 ノートモデル
```
Note {
  id: string (primary key)
  title: string
  content: string (markdown)
  projectId: string (foreign key -> Project.id)
  createdAt: timestamp
  updatedAt: timestamp
}
```

### 4.4 タグモデル
```
Tag {
  id: string (primary key)
  name: string
  projectId: string (foreign key -> Project.id)
  createdAt: timestamp
}
```

### 4.5 ノートタグ関連モデル
```
NoteTag {
  noteId: string (foreign key -> Note.id)
  tagId: string (foreign key -> Tag.id)
  primary key (noteId, tagId)
}
```

### 4.6 Supabaseスキーマ設計

#### 4.6.1 テーブル構造
- 上記のデータモデルに対応するテーブルをSupabase上に作成
- 各テーブルには適切なインデックスを設定（検索パフォーマンス向上のため）
- **allowed_emails**テーブル:
  ```
  AllowedEmail {
    id: string (primary key)
    email: string (unique)
    createdAt: timestamp
    createdBy: string (foreign key -> User.id, nullable)
  }
  ```

#### 4.6.2 RLSポリシー（Row Level Security）
- **ユーザーテーブル**: 自分自身のデータのみ読み取り/更新可能
- **プロジェクトテーブル**: 所有者のみ読み取り/更新/削除可能
- **ノートテーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **タグテーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **ノートタグ関連テーブル**: プロジェクト所有者のみ読み取り/更新/削除可能
- **allowed_emailsテーブル**: 管理者ロールを持つユーザーのみ読み取り/作成/更新/削除可能

#### 4.6.3 データベーストリガー
- ノート作成/更新時にタグを自動抽出するトリガー
- タグ削除時に関連するノートタグ関連レコードを削除するトリガー

## 5. 技術スタック

### 5.1 フロントエンド
- **フレームワーク**: Next.js
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS, Shadcn UI
- **状態管理**: Context API
- **エディタ**: Tiptap
- **テスト**: Vitest, React Testing Library, Storybook, PlayWright

### 5.2 バックエンド
- **BaaS**: Supabase
- **データベース**: Supabase Database
- **認証**: Supabase Authentication

### 5.3 インフラストラクチャ
- **ホスティング**: Vercel
- **データベースホスティング**: Supabase
- **ストレージ**: Supabase Storage
- **CDN**: Vercel Edge Network

## 6. 実装詳細

### 6.1 認証フロー
- **ユーザー登録**:
  1. 管理者がSupabaseダッシュボードで承認済みメールアドレスを登録
  2. ユーザーがGoogle OAuthでログイン
  3. 初回ログイン時にユーザープロファイル情報を保存
- **ログイン**:
  1. Google OAuthによるログイン
  2. 開発環境では環境変数によりID/パスワードログインも可能
- **ログアウト**:
  1. Supabase認証セッションの破棄
  2. クライアント側のキャッシュクリア

### 6.2 状態管理戦略
- **Context API**:
  - ユーザー認証状態の管理
  - テーマ設定（ダークモード/ライトモード）
  - グローバル設定の管理

### 6.3 キャッシュ戦略
- ローカルストレージを活用したキャッシュ管理
- ノートデータは5分間キャッシュ
- プロジェクト一覧は1時間キャッシュ
- タグデータは10分間キャッシュ
- ユーザー情報は24時間キャッシュ

### 6.4 タグ抽出ロジック
- **抽出方法**:
  1. マークダウンコンテンツから正規表現 `/#([a-zA-Z0-9_\-/\p{L}\p{N}]+)/gu` を使用してタグを抽出
  2. 抽出したタグをデータベースに保存（既存タグは更新、新規タグは作成）
  3. ノートとタグの関連付けを更新
  4. タグは半角スペースまたは全角スペース以外の文字で構成される
- **タグと同名のノート検出**:
  1. タグ名と同じタイトルのノートを検索
  2. 存在する場合は青色、存在しない場合はピンク色でタグを表示
  3. タグクリック時に同名ノートが存在すればそのノートに遷移

### 6.5 エディタ実装
- **使用ライブラリ**: Tiptap
- **主要機能**:
  - マークダウンライクなショートカットキー（`#`, `-`, `*` など）
  - タグの自動補完
  - WYSIWYG編集体験

### 6.6 エラーハンドリング戦略
- **ネットワークエラー**:
  - オフライン時はローカルストレージにデータを一時保存
  - オンライン復帰時に自動同期
  - 競合解決のためのマージ戦略を実装
- **認証エラー**:
  - セッション期限切れ時の自動リフレッシュ
  - リフレッシュ失敗時のログインページへのリダイレクト
- **データ操作エラー**:
  - 楽観的更新の失敗時のロールバック
  - ユーザーへのエラー通知（トースト表示）
  - エラーログの記録と分析

## 7. コーディングガイドライン

### 7.1 コーディング規約
- TypeScriptの型定義を厳格に行う
- Biomeを使用したコード品質の維持
- コンポーネント設計はPresentational/Containerパターンに従う
- テスト駆動開発（TDD）の採用
  - Presentationalコンポーネントのテスト
    - Storybookのストーリーの作成
  - Containerコンポーネントのテスト
    - vitestによる単体テスト

### 7.2 ディレクトリ構造
```
/
├── frontend/
│   ├── .storybook/            # Storybook 設定
│   ├── docs/                  # フロントエンド専用のドキュメント
│   └── src/                   # Next.js アプリディレクトリ
│       ├── app/               # アプリのエントリポイント (Next.js App Router 使用)
│       │   └── (pages/)       # 各ページのファイル (app router の規約に従う)
│       ├── components/        # 再利用可能な UI コンポーネント (アプリ全体で共有)
│       │   ├── ComponentName/ # 例: Button, Input, Header など
│       │   │   ├── index.tsx
│       │   │   └── ComponentName.stories.tsx
│       │   └── ...
│       ├── features/          # 特定の機能に関するコンポーネント、ロジック、ページ
│       │   ├── featureName/   # 例: auth, productList, checkout など
│       │   │   ├── components/      # 機能固有の Presentational Components
│       │   │   │   ├── ComponentName/
│       │   │   │   │   ├── index.tsx
│       │   │   │   │   └── ComponentName.stories.tsx
│       │   │   │   └── ...
│       │   │   ├── containers/     # 機能固有の Container Components (ロジックと状態管理)
│       │   │   │   ├── ContainerName/
│       │   │   │   │   ├── index.tsx
│       │   │   │   │   └── useContainerHook.ts  # コンテナ用のカスタムフック
│       │   │   │   └── ...
│       │   │   ├── hooks/          # 機能固有のカスタムフック
│       │   │   ├── types/          # 機能固有の型定義
│       │   │   └── utils/          # 機能固有のユーティリティ関数
│       │   └── ...
│       ├── hooks/             # アプリ全体で共有するカスタム React フック
│       ├── lib/               # 共有ユーティリティとライブラリ
│       ├── services/          # API サービスレイヤー (API クライアント、データ変換など)
│       └── utils/             # アプリ全体で共有するユーティリティ関数
└── docs/                 # プロジェクトドキュメント
```

### 7.3 開発フロー
- Gitブランチ戦略: GitHub Flow
- プルリクエスト必須
  - レビューは一人で開発しているため不要
- CIパイプラインによる自動テスト
- セマンティックバージョニングの採用

### 7.4 テスト戦略
- ユニットテスト: Vitest
- コンポーネントテスト: React Testing Library、Storybook
- E2Eテスト: PlayWright
- テストカバレッジ目標: 80%以上

## 8. マイルストーンとリリース計画

### 8.1 フェーズ1: MVP（最小実用製品）
- 基本的なユーザー認証
- プロジェクト作成・管理
- 基本的なノート作成・編集機能
- シンプルなタグ機能

### 8.2 フェーズ2: 機能拡張
- 高度なマークダウン機能
- タグナビゲーションの強化
- 検索機能の強化
- エクスポート・インポート機能

### 8.3 フェーズ3: 洗練と最適化
- UI/UXの改善
- パフォーマンス最適化
- モバイル対応の強化
- 追加機能の実装

## 9. 用語集
- **ノート**: マークダウン形式で作成されるドキュメント
- **プロジェクト**: ノートを整理するためのコンテナ
- **タグ**: ノートを分類・関連付けるためのキーワード
- **マークダウン**: テキストを構造化するための軽量マークアップ言語

## 10. 付録

### 10.1 参考資料
- Next.js ドキュメント: [Next.js](https://nextjs.org/docs)
- Supabase ドキュメント: [Supabase](https://supabase.com/docs)
- Tiptap ドキュメント: [Tiptap](https://tiptap.dev/docs)

### 10.2 UI/UXデザイン参考
- 基本的なカラーパレット: ダークモード/ライトモード対応
- フォント: システムフォントスタック（読みやすさ重視）
- アイコン: Heroicons または Material Icons
