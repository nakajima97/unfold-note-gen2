# 要件定義書 - 実装詳細（コア機能）

## 実装詳細

### 1.1 認証フロー
- **ユーザー登録**:
  1. 管理者がSupabaseダッシュボードで承認済みメールアドレスを登録
  2. ユーザーがGoogle OAuthでログイン
  3. 初回ログイン時にユーザープロファイル情報を保存
- **ログイン**:
  1. Google OAuthによるログイン
  2. 開発環境では環境変数によりID/パスワードログインも可能
- **ログアウト**:
  1. Supabase認証セッションの破棄
  2. クライアント側のキャッシュクリア

### 1.2 状態管理戦略
- **Context API**:
  - ユーザー認証状態の管理
  - テーマ設定（ダークモード/ライトモード）
  - グローバル設定の管理

### 1.3 キャッシュ戦略
- ローカルストレージを活用したキャッシュ管理
- ノートデータは5分間キャッシュ
- プロジェクト一覧は1時間キャッシュ
- タグデータは10分間キャッシュ
- ユーザー情報は24時間キャッシュ

### 1.4 タグ抽出ロジック
- **抽出方法**:
  1. マークダウンコンテンツから正規表現 `/#([a-zA-Z0-9_\-/\p{L}\p{N}]+)/gu` を使用してタグを抽出
     1. タグに使用できる文字は、半角英数字、全角英数字、アンダースコア、ハイフン、スラッシュ、漢字、ひらがな、カタカナです
  2. 抽出したタグをデータベースに保存（既存タグは更新、新規タグは作成）
  3. ノートとタグの関連付けを更新
  4. タグは半角スペースまたは全角スペース以外の文字で構成される
- **実装場所**:
  1. Next.jsのAPIルートで実装する
  2. フロントエンドからノート保存/更新リクエスト時にタグ抽出処理を実行
  3. データベーストリガーではなくアプリケーションロジックとして実装することで、ビジネスロジックとデータ永続化の責務を分離
- **タグと同名のノート検出**:
  1. タグ名と同じタイトルのノートを検索
  2. 存在する場合は青色、存在しない場合はピンク色でタグを表示
  3. タグクリック時に同名ノートが存在すればそのノートに遷移

### 1.5 ファイルストレージ実装
- **ストレージサービス**: Supabase Storage
- **アクセス制御**:
  1. Row Level Security (RLS) ポリシーによるアクセス制御
  2. プロジェクト所有者のみがファイルの読み取り・書き込み権限を持つ
- **ファイル管理**:
  1. プロジェクトごとに独立したバケットを作成
  2. ファイル名の衝突を避けるためにUUIDベースのファイル名を使用
  3. オリジナルファイル名とメタデータを別途データベースに保存
  4. ファイルサイズ上限：10MB
  5. フェーズ3でプロジェクトごとに1GBの容量制限を実装
  1. ファイル管理画面の実装（一覧表示、削除、メタデータ確認など）
- **メタデータ管理**:
  1. データベースでファイルメタデータを管理（ファイル名、サイズ、タイプ、アップロード日時など）
  2. 専用のFileテーブルでファイル情報を管理（オリジナル名、ストレージパス、MIME型、サイズなど）
  3. ノートとファイルの関連付けをデータベースで管理
  4. フェーズ3でファイル管理画面を実装
- **画像処理**:
  1. 表示時のみ画像をリサイズ（大きい画像は表示領域に収まるようにリサイズ）
  2. アップロード時のリサイズは行わない
  3. 画像の最適化（WebP形式への変換など）
  4. サムネイル生成

### 1.6 エディタ実装
- **使用ライブラリ**: Tiptap
- **主要機能**:
  - マークダウンライクなショートカットキー（`#`, `-`, `*` など）
  - タグの自動補完
  - WYSIWYG編集体験

### 1.7 エラーハンドリング戦略
- **ネットワークエラー**:
  - オフライン時はローカルストレージにデータを一時保存
  - オンライン復帰時に自動同期
  - 競合解決のためのマージ戦略を実装
- **認証エラー**:
  - セッション期限切れ時の自動リフレッシュ
  - リフレッシュ失敗時のログインページへのリダイレクト
- **データ操作エラー**:
  - 楽観的更新の失敗時のロールバック
  - ユーザーへのエラー通知（トースト表示）
  - エラーログの記録と分析

### 1.8 URL識別子の実装
- **使用技術**: nanoid
- **設定詳細**:
  - 文字数: 15文字（十分な一意性と短さのバランス）
  - 使用文字セット: 紛らわしい文字（0, O, 1, I, l など）を除外したアルファベット
    ```
    23456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz
    ```
  - 衝突確率: 個人利用を前提として、数百年以上衝突しない確率を確保
- **実装方針**:
  - プロジェクトとノートの作成時に自動生成
  - データベースの`urlId`フィールドに保存
  - URLルーティングで以下の形式を使用:
    - プロジェクト: `/projects/[urlId]`
    - ノート: `/projects/[projectUrlId]/notes/[noteUrlId]`
  - 主キーとは別に管理し、URLからデータベースの内部IDを隠蔽
- **衝突対策**:
  - 生成時にデータベースで一意性をチェック
  - 万が一衝突した場合は再生成
  - データベースレベルでユニーク制約を設定
